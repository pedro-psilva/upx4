{% extends "base.html" %}

{% block title %}Mapa - Meu Bairro Melhor{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-gradient rounded-2xl p-8 mb-8 text-white relative overflow-hidden">
    <div class="absolute inset-0 bg-black bg-opacity-20"></div>
    <div class="relative z-10">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 animate-fadeInUp">
                Mapa Interativo do Bairro
            </h1>
            <p class="text-xl mb-8 opacity-90 animate-fadeInUp" style="animation-delay: 0.2s;">
                Explore as propostas e sugestões da comunidade em um mapa interativo
            </p>
        </div>
    </div>
    <!-- Decorative elements -->
    <div class="absolute top-4 right-4 text-white opacity-20">
        <i class="fas fa-map-marked-alt text-6xl"></i>
    </div>
    <div class="absolute bottom-4 left-4 text-white opacity-20">
        <i class="fas fa-location-dot text-4xl"></i>
    </div>
</div>

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-neutral-900">Propostas no Mapa</h2>
            <p class="text-neutral-600">Visualize as propostas no mapa do bairro</p>
        </div>
        
        <div class="flex items-center space-x-4">
            <!-- Search -->
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400"></i>
                <input type="text" id="mapSearch" placeholder="Buscar propostas..." 
                       class="pl-9 pr-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-citizenship-500 focus:border-citizenship-500">
            </div>
            
            <!-- Filter Toggle -->
            <button id="filterToggle" class="px-4 py-2 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition-colors">
                <i class="fas fa-filter mr-2"></i>Filtros
            </button>
        </div>
    </div>

    <!-- Filter Panel -->
    <div id="filterPanel" class="bg-white rounded-xl shadow-lg border border-neutral-200 p-6 hidden">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-neutral-900">Filtros do Mapa</h3>
            <button id="closeFilters" class="p-2 text-neutral-500 hover:text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Category Filter -->
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">
                    <i class="fas fa-tags mr-1 text-neutral-500"></i>Categoria
                </label>
                <select id="categoryFilter" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-citizenship-500 focus:border-citizenship-500">
                    <option value="all">Todas as categorias</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">
                    <i class="fas fa-filter mr-1 text-neutral-500"></i>Status
                </label>
                <select id="statusFilter" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-citizenship-500 focus:border-citizenship-500">
                    <option value="all">Todos os status</option>
                    <option value="pending">Pendente</option>
                    <option value="approved">Aprovado</option>
                    <option value="in_progress">Em Andamento</option>
                    <option value="completed">Concluído</option>
                    <option value="rejected">Rejeitado</option>
                </select>
            </div>
            
            <!-- Priority Filter -->
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">
                    <i class="fas fa-exclamation-triangle mr-1 text-neutral-500"></i>Prioridade
                </label>
                <select id="priorityFilter" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-citizenship-500 focus:border-citizenship-500">
                    <option value="all">Todas as prioridades</option>
                    <option value="high">Alta</option>
                    <option value="medium">Média</option>
                    <option value="low">Baixa</option>
                </select>
            </div>
        </div>
        
        <div class="mt-6 flex justify-end space-x-3">
            <button id="clearFilters" class="px-4 py-2 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition-colors">
                <i class="fas fa-eraser mr-2"></i>Limpar
            </button>
            <button id="applyFilters" class="btn-primary px-6 py-3 rounded-xl hover:shadow-lg transition-all duration-300 font-semibold">
                <i class="fas fa-check mr-2"></i>Aplicar Filtros
            </button>
        </div>
    </div>

    <!-- Map Container -->
    <div class="bg-white rounded-2xl shadow-lg border border-neutral-200 overflow-hidden">
        <div id="map" class="map-container w-full" style="width: 100% !important; height: 100% !important; min-height: 400px; z-index: 1;"></div>
    </div>

    <!-- Selected Proposal Info -->
    <div id="selectedProposal" class="bg-white rounded-2xl shadow-lg border border-neutral-200 p-6 hidden">
        <div class="flex items-start justify-between mb-4">
            <h3 id="selectedTitle" class="text-lg font-semibold text-neutral-900"></h3>
            <button id="closeSelected" class="p-2 text-neutral-500 hover:text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="selectedContent" class="space-y-4">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>

    <!-- Legend -->
    <div class="bg-white rounded-xl shadow-lg border border-neutral-200 p-6">
        <h3 class="text-lg font-semibold text-neutral-900 mb-4 flex items-center">
            <i class="fas fa-map-signs mr-2 text-neutral-500"></i>Legenda do Mapa
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for category in categories %}
            <div class="flex items-center space-x-3 p-3 rounded-lg hover:bg-neutral-50 transition-colors">
                <div class="w-6 h-6 rounded-full shadow-sm flex items-center justify-center" style="background-color: {{ category.color }}">
                    <i class="fas fa-{{ category.icon }} text-white text-xs"></i>
                </div>
                <span class="text-sm font-medium text-neutral-700">{{ category.name }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let map;
    let markers = [];
    let selectedProposal = null;
    
    // Initialize map
    function initMap() {
        console.log('Initializing map...');
        
        // Check if map element exists
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error('Map element not found!');
            return;
        }
        
        console.log('Map element found, creating map...');
        
        // Center on Belo Horizonte, MG
        map = L.map('map', {
            center: [-19.9167, -43.9345],
            zoom: 13,
            zoomControl: true,
            attributionControl: true,
            dragging: true,
            touchZoom: true,
            doubleClickZoom: true,
            scrollWheelZoom: true,
            boxZoom: true,
            keyboard: true
        });
        console.log('Map created and centered');
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19,
            minZoom: 3
        }).addTo(map);
        console.log('Tiles added to map');
        
        // Load proposals
        loadProposals();
        
        // Force map resize after a short delay
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
                console.log('Map size invalidated');
            }
        }, 500);
    }
    
    // Load proposals from API
    async function loadProposals() {
        try {
            console.log('Loading proposals from API...');
            const response = await fetch('/api/map-proposals');
            const data = await response.json();
            
            console.log('Proposals loaded:', data.proposals.length);
            
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add markers for each proposal
            data.proposals.forEach(proposal => {
                console.log('Adding marker for proposal:', proposal.title, 'at', proposal.latitude, proposal.longitude);
                addProposalMarker(proposal);
            });
            
            console.log('Total markers added:', markers.length);
            
            // Ajustar o mapa para mostrar todos os marcadores
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                const bounds = group.getBounds();
                console.log('Map bounds:', bounds);
                map.fitBounds(bounds.pad(0.1));
                console.log('Map bounds adjusted to show all markers');
                
                // Force another resize after bounds adjustment
                setTimeout(() => {
                    map.invalidateSize();
                    console.log('Map size invalidated after bounds adjustment');
                }, 100);
            }
        } catch (error) {
            console.error('Error loading proposals:', error);
        }
    }
    
    // Add proposal marker to map
    function addProposalMarker(proposal) {
        console.log('Adding marker for:', proposal.title, 'Coordinates:', proposal.latitude, proposal.longitude);
        
        // Validate coordinates
        if (!proposal.latitude || !proposal.longitude || 
            isNaN(proposal.latitude) || isNaN(proposal.longitude)) {
            console.warn('Invalid coordinates for proposal:', proposal.title, proposal.latitude, proposal.longitude);
            return;
        }
        
        // Get category info
        const category = getCategoryInfo(proposal.category);
        
        // Create custom icon
        const icon = L.divIcon({
            className: 'custom-marker',
            html: `
                <div class="w-6 h-6 rounded-full border-2 border-white shadow-lg flex items-center justify-center" 
                     style="background-color: ${category.color}">
                    <i class="fas fa-${category.icon} text-white text-xs"></i>
                </div>
            `,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        
        // Create marker
        const marker = L.marker([proposal.latitude, proposal.longitude], { icon })
            .addTo(map)
            .bindPopup(`
                <div class="p-2">
                    <h4 class="font-semibold text-sm mb-1">${proposal.title}</h4>
                    <p class="text-xs text-gray-600 mb-2">${proposal.address}</p>
                    <div class="flex items-center justify-between text-xs">
                        <span class="px-2 py-1 rounded-full" style="background-color: ${category.color}20; color: ${category.color}">
                            ${category.name}
                        </span>
                        <span class="text-gray-500">${proposal.votes_count} votos</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        Lat: ${proposal.latitude}, Lng: ${proposal.longitude}
                    </div>
                </div>
            `);
        
        // Store proposal data in marker for filtering
        marker.proposal = proposal;
        
        // Add click handler
        marker.on('click', function() {
            selectProposal(proposal);
        });
        
        markers.push(marker);
        console.log('Marker added successfully for:', proposal.title);
    }
    
    // Get category info
    function getCategoryInfo(categoryId) {
        const categories = {{ categories | tojson }};
        const category = categories.find(cat => cat.id === categoryId);
        
        if (category) {
            // Ensure category has proper icon
            let icon = category.icon;
            if (!icon || icon === 'circle') {
                // Set appropriate icon based on category name
                const name = category.name.toLowerCase();
                if (name.includes('arborização') || name.includes('árvore')) {
                    icon = 'tree';
                } else if (name.includes('acessibilidade') || name.includes('acessível')) {
                    icon = 'wheelchair';
                } else if (name.includes('lazer') || name.includes('recreação')) {
                    icon = 'gamepad';
                } else if (name.includes('infraestrutura') || name.includes('obra')) {
                    icon = 'tools';
                } else if (name.includes('iluminação') || name.includes('luz')) {
                    icon = 'lightbulb';
                } else if (name.includes('segurança')) {
                    icon = 'shield-alt';
                } else if (name.includes('transporte') || name.includes('trânsito')) {
                    icon = 'car';
                } else {
                    icon = 'map-marker-alt';
                }
            }
            
            return {
                name: category.name,
                icon: icon,
                color: category.color || '#6B7280'
            };
        }
        
        return {
            name: 'Outros',
            icon: 'map-marker-alt',
            color: '#6B7280'
        };
    }
    
    // Select proposal
    function selectProposal(proposal) {
        selectedProposal = proposal;
        
        // Update selected proposal info
        document.getElementById('selectedTitle').textContent = proposal.title;
        
        const category = getCategoryInfo(proposal.category);
        const statusText = {
            'pending': 'Pendente',
            'approved': 'Aprovado',
            'in_progress': 'Em Andamento',
            'completed': 'Concluído',
            'rejected': 'Rejeitado'
        }[proposal.status] || proposal.status;
        
        const priorityText = {
            'low': 'Baixa',
            'medium': 'Média',
            'high': 'Alta'
        }[proposal.priority] || proposal.priority;
        
        document.getElementById('selectedContent').innerHTML = `
            <div class="space-y-3">
                <p class="text-gray-600 text-sm">${proposal.description}</p>
                
                <div class="flex items-center space-x-2 text-sm">
                    <i class="fas fa-${category.icon}" style="color: ${category.color}"></i>
                    <span>${category.name}</span>
                    <span>•</span>
                    <span class="status-${proposal.status} px-2 py-1 text-xs rounded-full">${statusText}</span>
                    <span>•</span>
                    <span class="priority-${proposal.priority} px-2 py-1 text-xs rounded-full">${priorityText}</span>
                </div>
                
                <div class="flex items-center text-sm text-gray-500">
                    <i class="fas fa-map-marker-alt mr-1"></i>
                    <span>${proposal.address}</span>
                </div>
                
                <div class="flex items-center justify-between text-sm text-gray-500">
                    <div class="flex items-center space-x-4">
                        <span><i class="fas fa-thumbs-up mr-1"></i>${proposal.votes_count} votos</span>
                        <span><i class="fas fa-comments mr-1"></i>${proposal.comments_count} comentários</span>
                    </div>
                    <span>${new Date(proposal.created_at).toLocaleDateString('pt-BR')}</span>
                </div>
                
                <div class="flex items-center space-x-2 pt-2">
                    <button onclick="voteProposal(${proposal.id})" 
                            class="flex-1 bg-blue-600 text-white py-2 px-3 rounded-md hover:bg-blue-700 transition-colors text-sm">
                        <i class="fas fa-thumbs-up mr-1"></i>Votar
                    </button>
                    <button onclick="commentProposal(${proposal.id})" 
                            class="flex-1 bg-gray-100 text-gray-700 py-2 px-3 rounded-md hover:bg-gray-200 transition-colors text-sm">
                        <i class="fas fa-comment mr-1"></i>Comentar
                    </button>
                    <a href="/proposta/${proposal.id}" 
                       class="bg-gray-100 text-gray-700 py-2 px-3 rounded-md hover:bg-gray-200 transition-colors text-sm">
                        <i class="fas fa-eye"></i>
                    </a>
                </div>
            </div>
        `;
        
        // Show selected proposal panel
        document.getElementById('selectedProposal').classList.remove('hidden');
    }
    
    // Filter functionality
    document.getElementById('filterToggle').addEventListener('click', function() {
        const panel = document.getElementById('filterPanel');
        panel.classList.toggle('hidden');
    });
    
    document.getElementById('applyFilters').addEventListener('click', function() {
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        const priority = document.getElementById('priorityFilter').value;
        
        // Filter markers
        markers.forEach(marker => {
            const proposal = marker.proposal;
            let show = true;
            
            if (category !== 'all' && proposal.category !== category) show = false;
            if (status !== 'all' && proposal.status !== status) show = false;
            if (priority !== 'all' && proposal.priority !== priority) show = false;
            
            if (show) {
                map.addLayer(marker);
            } else {
                map.removeLayer(marker);
            }
        });
        
        // Hide filter panel
        document.getElementById('filterPanel').classList.add('hidden');
    });
    
    document.getElementById('clearFilters').addEventListener('click', function() {
        document.getElementById('categoryFilter').value = 'all';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('priorityFilter').value = 'all';
        
        // Show all markers
        markers.forEach(marker => map.addLayer(marker));
    });
    
    // Close filters panel
    document.getElementById('closeFilters').addEventListener('click', function() {
        document.getElementById('filterPanel').classList.add('hidden');
    });
    
    // Resize map when window is resized
    window.addEventListener('resize', function() {
        setTimeout(function() {
            map.invalidateSize();
        }, 100);
    });
    
    // Handle sidebar toggle for map responsiveness
    document.getElementById('sidebar-toggle').addEventListener('click', function() {
        setTimeout(function() {
            map.invalidateSize();
        }, 300);
    });
    
    document.getElementById('sidebar-close').addEventListener('click', function() {
        setTimeout(function() {
            map.invalidateSize();
        }, 300);
    });
    
    // Close selected proposal
    document.getElementById('closeSelected').addEventListener('click', function() {
        document.getElementById('selectedProposal').classList.add('hidden');
        selectedProposal = null;
    });
    
    // Search functionality
    document.getElementById('mapSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        markers.forEach(marker => {
            const proposal = marker.proposal;
            const matches = proposal.title.toLowerCase().includes(searchTerm) ||
                          proposal.description.toLowerCase().includes(searchTerm) ||
                          proposal.address.toLowerCase().includes(searchTerm);
            
            if (matches) {
                map.addLayer(marker);
            } else {
                map.removeLayer(marker);
            }
        });
    });
    
    // Vote and comment functions (reuse from index.html)
    async function voteProposal(proposalId) {
        {% if not current_user.is_authenticated %}
            openLoginModal();
            return;
        {% endif %}

        try {
            const response = await fetch(`/votar/${proposalId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update selected proposal if it's the same
                if (selectedProposal && selectedProposal.id === proposalId) {
                    selectedProposal.votes_count = data.votes_count;
                    // Refresh the selected proposal display
                    selectProposal(selectedProposal);
                }
                
                showNotification(data.voted ? 'Voto adicionado!' : 'Voto removido!');
            } else {
                showNotification(data.message, 'error');
            }
        } catch (error) {
            showNotification('Erro ao votar', 'error');
        }
    }
    
    function commentProposal(proposalId) {
        {% if not current_user.is_authenticated %}
            openLoginModal();
            return;
        {% endif %}
        
        window.location.href = `/proposta/${proposalId}#comments`;
    }
    
    
    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Small delay to ensure DOM is fully loaded
        setTimeout(initMap, 100);
        
        // Additional resize after a longer delay to ensure all elements are loaded
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
                console.log('Final map size invalidation');
            }
        }, 1000);
    });
</script>

<style>
    .custom-marker {
        background: transparent !important;
        border: none !important;
    }
    
    .leaflet-popup-content {
        margin: 0 !important;
    }
    
    /* Ensure map container is visible */
    #map {
        width: 100% !important;
        height: 100% !important;
        min-height: 400px;
        z-index: 1;
    }
    
    .map-container {
        position: relative;
        z-index: 1;
        width: 100% !important;
        height: 100% !important;
        min-height: 400px;
    }
    
    /* Ensure Leaflet controls are visible */
    .leaflet-control-container {
        z-index: 10;
    }
    
    /* Ensure map is interactive */
    .leaflet-container {
        pointer-events: auto !important;
        touch-action: auto !important;
    }
    
    /* Ensure map controls are interactive */
    .leaflet-control-zoom {
        pointer-events: auto !important;
    }
    
    .leaflet-control-attribution {
        pointer-events: auto !important;
    }
    
    /* Ensure no overlay is blocking map interaction */
    .map-container {
        pointer-events: auto !important;
    }
    
    .map-container * {
        pointer-events: auto !important;
    }
    
    /* Remove any potential overlay blocking */
    .leaflet-overlay-pane {
        pointer-events: auto !important;
    }
    
    .leaflet-marker-pane {
        pointer-events: auto !important;
    }
</style>
{% endblock %}
