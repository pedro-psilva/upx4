{% extends "base.html" %}

{% block title %}Criar Proposta - Meu Bairro Melhor{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Nova Proposta</h1>
        <p class="text-gray-600">Compartilhe sua ideia para melhorar o bairro</p>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <form id="createProposalForm">
            <div class="space-y-6">
                <!-- Title -->
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        Título da Proposta *
                    </label>
                    <input type="text" id="title" name="title" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Ex: Instalação de luminárias LED na Rua das Flores">
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Descrição *
                    </label>
                    <textarea id="description" name="description" rows="4" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Descreva detalhadamente sua proposta, explicando o problema e a solução sugerida..."></textarea>
                </div>

                <!-- Category and Priority -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                            Categoria *
                        </label>
                        <select id="category" name="category" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione uma categoria</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">
                            Prioridade
                        </label>
                        <select id="priority" name="priority"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="medium">Média</option>
                            <option value="low">Baixa</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                </div>

                <!-- Location -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Localização *
                    </label>
                    <div class="space-y-4">
                        <!-- Search Options -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h3 class="text-sm font-medium text-gray-700 mb-3">Buscar Localização</h3>
                            
                            <!-- CEP Search -->
                            <div class="mb-4">
                                <label for="cep" class="block text-sm text-gray-600 mb-1">
                                    Buscar por CEP
                                </label>
                                <div class="flex space-x-2">
                                    <input type="text" id="cep" name="cep"
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="00000-000" maxlength="9">
                                    <button type="button" id="buscarCepBtn"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                                <div id="cepResult" class="mt-2 text-sm text-gray-600 hidden"></div>
                            </div>

                            <!-- Address Search -->
                            <div>
                                <label for="endereco" class="block text-sm text-gray-600 mb-1">
                                    Buscar por Endereço
                                </label>
                                <div class="flex space-x-2">
                                    <input type="text" id="endereco" name="endereco"
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Ex: Rua das Flores, 123 - Centro">
                                    <button type="button" id="buscarEnderecoBtn"
                                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                                <div id="enderecoResult" class="mt-2 text-sm text-gray-600 hidden"></div>
                            </div>
                        </div>

                        <!-- Address Input -->
                        <div>
                            <label for="address" class="block text-sm text-gray-600 mb-1">
                                Endereço Final
                            </label>
                            <input type="text" id="address" name="address" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Endereço será preenchido automaticamente ou digite manualmente">
                        </div>

                        <!-- Map -->
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">
                                Localização no mapa (atualizada automaticamente)
                            </label>
                            <div id="locationMap" style="height: 300px;" class="border border-gray-300 rounded-md"></div>
                            <p class="text-xs text-gray-500 mt-1">
                                O mapa será atualizado automaticamente quando você buscar um endereço ou CEP
                            </p>
                        </div>

                        <!-- Coordinates (hidden) -->
                        <input type="hidden" id="latitude" name="latitude" required>
                        <input type="hidden" id="longitude" name="longitude" required>
                    </div>
                </div>

                <!-- Guidelines -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-blue-900 mb-2">
                        <i class="fas fa-info-circle mr-1"></i>Diretrizes para uma boa proposta
                    </h3>
                    <ul class="text-sm text-blue-800 space-y-1">
                        <li>• Seja específico sobre o local e o problema</li>
                        <li>• Explique claramente a solução proposta</li>
                        <li>• Considere o impacto na comunidade</li>
                        <li>• Use um título descritivo e conciso</li>
                    </ul>
                </div>

                <!-- Actions -->
                <div class="flex items-center justify-end space-x-4 pt-4 border-t border-gray-200">
                    <a href="{{ url_for('index') }}" 
                       class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancelar
                    </a>
                    <button type="submit" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Criar Proposta
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let locationMap;
    let selectedMarker = null;
    
    // Initialize location map
    function initLocationMap() {
        // Center on Belo Horizonte, MG
        const bhLat = -19.9167;
        const bhLng = -43.9345;
        
        locationMap = L.map('locationMap').setView([bhLat, bhLng], 12);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(locationMap);
        
        // Store map reference globally for other functions
        window.locationMap = locationMap;
        
        // Add a default marker in Belo Horizonte center
        window.locationMarker = L.marker([bhLat, bhLng])
            .addTo(locationMap)
            .bindPopup('Belo Horizonte - MG')
            .openPopup();
        
        // Set default coordinates
        document.getElementById('latitude').value = bhLat;
        document.getElementById('longitude').value = bhLng;
    }
    
    // ===== FUNCIONALIDADES DE BUSCA =====
    
    // Buscar por CEP
    document.getElementById('buscarCepBtn').addEventListener('click', async function() {
        const cep = document.getElementById('cep').value.trim();
        const cepResult = document.getElementById('cepResult');
        
        if (!cep) {
            showNotification('Digite um CEP para buscar', 'error');
            return;
        }
        
        // Mostrar loading
        cepResult.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Buscando CEP...';
        cepResult.classList.remove('hidden');
        
        try {
            const response = await fetch('/api/buscar-cep', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ cep })
            });
            
            const data = await response.json();
            
            if (data.sucesso) {
                // Preencher campos automaticamente
                document.getElementById('address').value = data.endereco_completo;
                document.getElementById('endereco').value = data.endereco_completo;
                
                // Buscar coordenadas do endereço
                await buscarCoordenadasEndereco(data.endereco_completo);
                
                cepResult.innerHTML = `<i class="fas fa-check-circle text-green-600 mr-2"></i>CEP encontrado: ${data.endereco_completo}`;
                cepResult.classList.remove('hidden');
                
                showNotification('CEP encontrado! Endereço preenchido automaticamente.');
            } else {
                cepResult.innerHTML = `<i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>${data.erro}`;
                cepResult.classList.remove('hidden');
            }
        } catch (error) {
            cepResult.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>Erro ao buscar CEP';
            cepResult.classList.remove('hidden');
            console.error('Erro ao buscar CEP:', error);
        }
    });
    
    // Buscar por Endereço
    document.getElementById('buscarEnderecoBtn').addEventListener('click', async function() {
        const endereco = document.getElementById('endereco').value.trim();
        const enderecoResult = document.getElementById('enderecoResult');
        
        if (!endereco) {
            showNotification('Digite um endereço para buscar', 'error');
            return;
        }
        
        // Mostrar loading
        enderecoResult.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Buscando endereço...';
        enderecoResult.classList.remove('hidden');
        
        try {
            const response = await fetch('/api/buscar-endereco', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ endereco })
            });
            
            const data = await response.json();
            
            if (data.sucesso && data.resultados.length > 0) {
                // Mostrar opções de endereços
                let opcoesHtml = '<div class="mt-2 space-y-2">';
                data.resultados.forEach((resultado, index) => {
                    opcoesHtml += `
                        <div class="p-2 border border-gray-200 rounded cursor-pointer hover:bg-gray-50" 
                             onclick="selecionarEndereco(${resultado.latitude}, ${resultado.longitude}, '${resultado.endereco}')">
                            <div class="text-sm font-medium">${resultado.endereco}</div>
                            <div class="text-xs text-gray-500">Lat: ${resultado.latitude.toFixed(6)}, Lng: ${resultado.longitude.toFixed(6)}</div>
                        </div>
                    `;
                });
                opcoesHtml += '</div>';
                
                enderecoResult.innerHTML = `<i class="fas fa-check-circle text-green-600 mr-2"></i>Encontrados ${data.resultados.length} endereços:${opcoesHtml}`;
                enderecoResult.classList.remove('hidden');
            } else {
                enderecoResult.innerHTML = `<i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>${data.erro || 'Endereço não encontrado'}`;
                enderecoResult.classList.remove('hidden');
            }
        } catch (error) {
            enderecoResult.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>Erro ao buscar endereço';
            enderecoResult.classList.remove('hidden');
            console.error('Erro ao buscar endereço:', error);
        }
    });
    
    // Função para selecionar endereço
    window.selecionarEndereco = function(latitude, longitude, endereco) {
        document.getElementById('address').value = endereco;
        document.getElementById('latitude').value = latitude;
        document.getElementById('longitude').value = longitude;
        
        // Atualizar mapa
        if (window.locationMap) {
            window.locationMap.setView([latitude, longitude], 16);
            if (window.locationMarker) {
                window.locationMarker.setLatLng([latitude, longitude]);
                window.locationMarker.bindPopup(`<strong>${endereco}</strong><br>Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`).openPopup();
            } else {
                window.locationMarker = L.marker([latitude, longitude])
                    .addTo(window.locationMap)
                    .bindPopup(`<strong>${endereco}</strong><br>Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`)
                    .openPopup();
            }
        }
        
        // Limpar resultados
        document.getElementById('enderecoResult').classList.add('hidden');
        
        showNotification('Endereço selecionado!');
    };
    
    // Função para buscar coordenadas de um endereço
    async function buscarCoordenadasEndereco(endereco) {
        try {
            const response = await fetch('/api/buscar-endereco', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ endereco })
            });
            
            const data = await response.json();
            
            if (data.sucesso && data.resultados.length > 0) {
                const primeiro = data.resultados[0];
                document.getElementById('latitude').value = primeiro.latitude;
                document.getElementById('longitude').value = primeiro.longitude;
                
                // Atualizar mapa
                if (window.locationMap) {
                    window.locationMap.setView([primeiro.latitude, primeiro.longitude], 16);
                    if (window.locationMarker) {
                        window.locationMarker.setLatLng([primeiro.latitude, primeiro.longitude]);
                        window.locationMarker.bindPopup(`<strong>${endereco}</strong><br>Lat: ${primeiro.latitude.toFixed(6)}, Lng: ${primeiro.longitude.toFixed(6)}`).openPopup();
                    } else {
                        window.locationMarker = L.marker([primeiro.latitude, primeiro.longitude])
                            .addTo(window.locationMap)
                            .bindPopup(`<strong>${endereco}</strong><br>Lat: ${primeiro.latitude.toFixed(6)}, Lng: ${primeiro.longitude.toFixed(6)}`)
                            .openPopup();
                    }
                }
            }
        } catch (error) {
            console.error('Erro ao buscar coordenadas:', error);
        }
    }
    
    // Formatação automática do CEP
    document.getElementById('cep').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 5) {
            value = value.substring(0, 5) + '-' + value.substring(5, 8);
        }
        e.target.value = value;
    });
    
    // Form submission
    document.getElementById('createProposalForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate required fields
        const title = document.getElementById('title').value.trim();
        const description = document.getElementById('description').value.trim();
        const category = document.getElementById('category').value;
        const address = document.getElementById('address').value.trim();
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;
        
        if (!title || !description || !category || !address || !latitude || !longitude) {
            showNotification('Por favor, preencha todos os campos obrigatórios', 'error');
            return;
        }
        
        // Show loading state
        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Criando...';
        submitButton.disabled = true;
        
        try {
            const response = await fetch('/criar-proposta', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title,
                    description,
                    category,
                    address,
                    latitude: parseFloat(latitude),
                    longitude: parseFloat(longitude),
                    priority: document.getElementById('priority').value
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Proposta criada com sucesso!');
                setTimeout(() => {
                    window.location.href = `/proposta/${data.id}`;
                }, 1500);
            } else {
                showNotification(data.message, 'error');
            }
        } catch (error) {
            showNotification('Erro ao criar proposta', 'error');
        } finally {
            // Reset button state
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        }
    });
    
    // Address geocoding (optional enhancement)
    document.getElementById('address').addEventListener('blur', function() {
        const address = this.value.trim();
        if (address && !document.getElementById('latitude').value) {
            // Here you could implement geocoding to automatically set coordinates
            // For now, we'll just show a message
            console.log('Address entered:', address);
        }
    });
    
    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', initLocationMap);
</script>
{% endblock %}
